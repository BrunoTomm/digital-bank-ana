apiVersion: v1
kind: ConfigMap
metadata:
  name: oracle-init-scripts
  namespace: bankmore
data:
  001_current_account.sql: |
    WHENEVER SQLERROR CONTINUE
    BEGIN
      EXECUTE IMMEDIATE '
        CREATE TABLE contacorrente (
          idcontacorrente VARCHAR2(37) PRIMARY KEY,
          numero NUMBER(10) NOT NULL UNIQUE,
          nome VARCHAR2(100) NOT NULL,
          ativo NUMBER(1) DEFAULT 0 NOT NULL,
          senha VARCHAR2(100) NOT NULL,
          salt VARCHAR2(100) NOT NULL,
          cpf VARCHAR2(14) NOT NULL UNIQUE,
          CONSTRAINT chk_contacorrente_ativo CHECK (ativo IN (0, 1))
        )';
    EXCEPTION WHEN OTHERS THEN IF SQLCODE NOT IN (-955) THEN RAISE; END IF;
    END;
    /
    BEGIN
      EXECUTE IMMEDIATE '
        CREATE TABLE movimento (
          idmovimento VARCHAR2(37) PRIMARY KEY,
          idcontacorrente VARCHAR2(37) NOT NULL,
          datamovimento VARCHAR2(25) NOT NULL,
          tipomovimento VARCHAR2(1) NOT NULL,
          valor NUMBER(18,2) NOT NULL,
          CONSTRAINT fk_movimento_conta FOREIGN KEY (idcontacorrente) REFERENCES contacorrente(idcontacorrente),
          CONSTRAINT chk_movimento_tipo CHECK (tipomovimento IN (''C'', ''D''))
        )';
    EXCEPTION WHEN OTHERS THEN IF SQLCODE NOT IN (-955) THEN RAISE; END IF;
    END;
    /
    BEGIN
      EXECUTE IMMEDIATE 'CREATE INDEX idx_movimento_idcontacorrente ON movimento(idcontacorrente)';
    EXCEPTION WHEN OTHERS THEN IF SQLCODE NOT IN (-955, -1408) THEN RAISE; END IF;
    END;
    /
    BEGIN
      EXECUTE IMMEDIATE '
        CREATE TABLE idempotencia_kafka (
          message_id VARCHAR2(255) PRIMARY KEY,
          processed_at TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL
        )';
    EXCEPTION WHEN OTHERS THEN IF SQLCODE NOT IN (-955) THEN RAISE; END IF;
    END;
    /
    WHENEVER SQLERROR EXIT 1
  002_transfer.sql: |
    WHENEVER SQLERROR CONTINUE
    BEGIN
      EXECUTE IMMEDIATE '
        CREATE TABLE transferencia (
          idtransferencia VARCHAR2(37) PRIMARY KEY,
          idcontacorrente_origem VARCHAR2(37) NOT NULL,
          idcontacorrente_destino VARCHAR2(37) NOT NULL,
          datamovimento VARCHAR2(25) NOT NULL,
          valor NUMBER(18,2) NOT NULL,
          CONSTRAINT fk_transf_conta_origem FOREIGN KEY (idcontacorrente_origem) REFERENCES contacorrente(idcontacorrente),
          CONSTRAINT fk_transf_conta_destino FOREIGN KEY (idcontacorrente_destino) REFERENCES contacorrente(idcontacorrente),
          CONSTRAINT chk_transf_contas_diferentes CHECK (idcontacorrente_origem <> idcontacorrente_destino)
        )';
    EXCEPTION WHEN OTHERS THEN IF SQLCODE NOT IN (-955) THEN RAISE; END IF;
    END;
    /
    BEGIN
      EXECUTE IMMEDIATE 'CREATE INDEX idx_transf_origem ON transferencia(idcontacorrente_origem)';
    EXCEPTION WHEN OTHERS THEN IF SQLCODE NOT IN (-955, -1408) THEN RAISE; END IF;
    END;
    /
    BEGIN
      EXECUTE IMMEDIATE 'CREATE INDEX idx_transf_destino ON transferencia(idcontacorrente_destino)';
    EXCEPTION WHEN OTHERS THEN IF SQLCODE NOT IN (-955, -1408) THEN RAISE; END IF;
    END;
    /
    WHENEVER SQLERROR EXIT 1
  003_fees.sql: |
    WHENEVER SQLERROR CONTINUE
    BEGIN
      EXECUTE IMMEDIATE '
        CREATE TABLE tarifas (
          idtarifa VARCHAR2(37) PRIMARY KEY,
          idcontacorrente VARCHAR2(37) NOT NULL,
          datamovimento VARCHAR2(25) NOT NULL,
          valor NUMBER(18,2) NOT NULL,
          CONSTRAINT fk_tarifas_conta FOREIGN KEY (idcontacorrente) REFERENCES contacorrente(idcontacorrente)
        )';
    EXCEPTION WHEN OTHERS THEN IF SQLCODE NOT IN (-955) THEN RAISE; END IF;
    END;
    /
    BEGIN
      EXECUTE IMMEDIATE 'CREATE INDEX idx_tarifas_idcontacorrente ON tarifas(idcontacorrente)';
    EXCEPTION WHEN OTHERS THEN IF SQLCODE NOT IN (-955, -1408) THEN RAISE; END IF;
    END;
    /
    WHENEVER SQLERROR EXIT 1
---
apiVersion: batch/v1
kind: Job
metadata:
  name: oracle-init
  namespace: bankmore
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 10
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: wait-oracle
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for Oracle..."
              for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20; do
                if nc -z oracle 1521; then
                  echo "Oracle is ready"
                  exit 0
                fi
                echo "Attempt $i - waiting 10s"
                sleep 10
              done
              exit 1
      containers:
        - name: oracle-init
          image: gvenzl/oracle-xe:21-slim-faststart
          command:
            - /bin/bash
            - -c
            - |
              for n in 1 2 3 4 5; do
                echo "Creating tables (attempt $n)..."
                for f in /scripts/*.sql; do
                  sqlplus -S bankmore/bankmore@//oracle:1521/XEPDB1 @"$f" </dev/null || true
                done
                if echo "SET FEEDBACK OFF HEADING OFF PAGESIZE 0
                SELECT 1 FROM user_tables WHERE table_name='CONTACORRENTE' AND ROWNUM=1;
                EXIT;" | sqlplus -S bankmore/bankmore@//oracle:1521/XEPDB1 2>/dev/null | grep -q "1"; then
                  echo "Tables ready."
                  exit 0
                fi
                echo "Retry $n/5 in 10s..."
                sleep 10
              done
              echo "Failed to create tables."
              exit 1
          volumeMounts:
            - name: scripts
              mountPath: /scripts
              readOnly: true
      volumes:
        - name: scripts
          configMap:
            name: oracle-init-scripts
